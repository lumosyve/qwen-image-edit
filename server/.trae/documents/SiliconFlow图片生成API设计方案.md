# SiliconFlow图片生成API设计方案（含日志功能）

## 1. 项目概述

本项目旨在设计一个基于FastAPI的RESTful API服务，允许用户通过HTTP请求上传图片、输入提示文案，调用SiliconFlow模型API并返回生成结果。同时，系统将记录详细的日志信息，包括API密钥、输入图片、输出图片和总耗时，支持增量更新。

## 2. 功能需求

### 2.1 核心功能
- 支持单张或多张图片上传
- 支持提示词和负面提示词输入
- 支持多种模型选择
- 支持图片尺寸、批量大小等参数调整
- 调用SiliconFlow API生成图片
- 返回生成结果

### 2.2 日志功能
- 记录每次API调用的详细信息
- 支持增量更新，每次调用追加到日志文件
- 记录内容包括：
  - API密钥（部分隐藏）
  - 输入图片信息
  - 输出图片信息
  - 总耗时（秒和毫秒）
  - 调用时间戳
  - 模型参数
  - 调用状态
  - 错误信息（如果失败）

## 3. 技术栈选择

| 类别 | 技术 | 选型理由 |
|------|------|----------|
| Web框架 | FastAPI | 高性能、自动生成API文档、内置数据验证 |
| API调用 | requests | 成熟稳定的HTTP客户端库 |
| 图片处理 | Pillow | Python主流图片处理库，支持多种格式 |
| 配置管理 | 直接配置文件 | 简化部署，避免环境变量依赖 |
| 数据验证 | Pydantic | FastAPI内置，强大的数据验证能力 |
| 日志处理 | Python标准库logging | 轻量级、无需额外依赖、支持JSON格式化 |

## 4. 系统架构设计

### 4.1 整体架构

```
+----------------+     +----------------+     +----------------+     +----------------+
|  客户端        |     |  FastAPI服务   |     | SiliconFlow API|     |  日志存储      |
|                |     |                |     |                |     |                |
|  POST请求       +----->  接收请求        +----->  调用模型       +----->  记录日志      |
|  (图片+参数)     |     |  验证参数        |     |  生成图片       |     |  (增量更新)    |
|                |     |  处理图片        |     |                |     |                |
|                |     |  返回结果        |     |                |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
```

### 4.2 模块划分

| 模块 | 职责 |
|------|------|
| API层 | 处理HTTP请求，提供RESTful接口 |
| 业务逻辑层 | 处理图片生成业务，调用第三方API |
| 日志层 | 记录API调用日志，支持增量更新 |
| 配置层 | 管理系统配置 |
| 工具层 | 提供图片处理、日志处理等工具函数 |

## 5. 核心功能设计

### 5.1 API设计

| API路径 | 方法 | 功能 | 输入参数 | 输出 |
|---------|------|------|----------|------|
| `/generate-images` | POST | 生成图片 | 图片文件、模型名称、提示词、负面提示词、图片尺寸、批量大小等 | 生成的图片列表、种子、时间信息 |
| `/health` | GET | 健康检查 | 无 | 服务状态、可用模型列表 |

### 5.2 图片生成流程

1. 客户端发送POST请求，包含图片文件和参数
2. API层接收请求，验证参数合法性
3. 业务逻辑层读取上传的图片，转换为base64格式
4. 调用SiliconFlow API，传递模型参数和图片数据
5. 接收API响应，处理生成的图片
6. 日志层记录完整的调用信息
7. API层返回生成结果给客户端

## 6. 日志功能设计

### 6.1 日志格式设计

采用JSON格式记录日志，便于后续分析和处理：

| 字段 | 类型 | 描述 |
|------|------|------|
| timestamp | string | 调用时间戳（ISO格式） |
| call_id | string | 调用唯一标识 |
| api_key | string | 隐藏的API密钥（前4位+后4位） |
| model | string | 模型名称 |
| prompt | string | 提示词 |
| negative_prompt | string | 负面提示词 |
| image_size | string | 图片尺寸 |
| batch_size | integer | 批量大小 |
| seed | integer | 种子 |
| num_inference_steps | integer | 推理步数 |
| guidance_scale | string | 引导比例 |
| cfg | string | CFG值 |
| input_images | array | 输入图片信息列表 |
| output_images | array | 输出图片信息列表 |
| total_time_seconds | float | 总耗时（秒） |
| total_time_ms | float | 总耗时（毫秒） |
| status | string | 调用状态（success/failed） |
| error_message | string | 错误信息（如果失败） |
| seed_used | integer | 实际使用的种子 |
| timing | object | 生成时间信息 |

### 6.2 图片信息格式

| 字段 | 类型 | 描述 |
|------|------|------|
| index | integer | 图片索引 |
| base64_preview | string | 图片base64编码前100字符（避免日志过大） |
| size | array | 图片尺寸（宽, 高） |

### 6.3 日志存储设计

- **存储位置**：本地文件系统，路径为 `logs/image_generation.log`
- **存储模式**：追加模式，支持增量更新
- **日志编码**：UTF-8
- **日志级别**：可配置（默认INFO）
- **日志轮转**：支持按大小或时间轮转（可选扩展功能）

### 6.4 日志记录时机

1. 记录API调用开始时间
2. 记录所有请求参数
3. 调用SiliconFlow API
4. 记录API响应结果
5. 计算总耗时
6. 生成完整日志记录
7. 追加到日志文件

## 7. 数据流设计

```
客户端请求 → API层 → 参数验证 → 图片处理 → 记录开始时间 → 调用SiliconFlow API → 记录结束时间 → 计算总耗时 → 生成日志 → 追加到日志文件 → 返回结果
```

## 8. 流程图

```
开始
  |
  v
客户端发送POST请求
  |
  v
API层接收请求
  |
  v
验证请求参数
  |
  v
读取上传的图片
  |
  v
记录开始时间
  |
  v
调用SiliconFlow API
  |
  v
接收API响应
  |
  v
记录结束时间和总耗时
  |
  v
生成日志记录
  |
  v
将日志追加到日志文件
  |
  v
返回生成结果
  |
  v
结束
```

## 9. 安全性设计

1. **API密钥保护**：日志中只显示前4位和后4位，隐藏中间部分
2. **图片信息保护**：只记录base64编码的前100个字符，避免完整图片泄露
3. **输入验证**：严格验证所有输入参数，防止恶意输入
4. **日志文件权限**：设置适当的文件权限，防止未授权访问
5. **HTTPS支持**：建议在生产环境中使用HTTPS
6. **CORS配置**：可根据需要配置跨域资源共享

## 10. 扩展性设计

1. **模型扩展**：支持动态添加新的模型
2. **日志扩展**：支持日志轮转、压缩和归档
3. **存储扩展**：支持将日志和图片存储到对象存储服务
4. **监控扩展**：支持添加监控指标，如调用次数、成功率、平均耗时等
5. **限流扩展**：支持添加API请求限流功能
6. **缓存扩展**：支持缓存生成结果，提高响应速度

## 11. 部署设计

1. **部署方式**：支持Docker容器化部署
2. **配置管理**：通过配置文件管理所有配置项
3. **日志管理**：日志文件可通过日志收集工具（如ELK Stack）进行集中管理
4. **监控告警**：可集成监控系统，如Prometheus + Grafana

## 12. 总结

本设计方案详细描述了基于FastAPI的SiliconFlow图片生成API服务的设计思路，包括核心功能、日志功能、技术栈选择、系统架构、数据流和流程图等。该方案注重安全性和扩展性，同时满足了用户对详细日志记录的需求。系统采用模块化设计，便于后续扩展和维护。